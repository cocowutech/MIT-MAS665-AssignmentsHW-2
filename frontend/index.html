<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Placement Agent</title>
	<style>
		body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; margin: 0; padding: 0; background: #0b1020; color: #f2f4f8; }
		.container { max-width: 820px; margin: 0 auto; padding: 24px; }
		.card { background: #111833; border: 1px solid #1e2a55; border-radius: 12px; padding: 20px; margin-top: 16px; }
		label { display: block; margin: 8px 0 4px; font-size: 14px; color: #c7d2fe; }
		input, textarea { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #e5e7eb; }
		button { background: #2563eb; color: white; border: none; padding: 10px 14px; border-radius: 8px; cursor: pointer; }
		button:disabled { opacity: 0.6; cursor: not-allowed; }
		.row { display: flex; gap: 12px; align-items: center; }
		.row > * { flex: 1; }
		.header { display: flex; justify-content: space-between; align-items: center; }
		.small { color: #93c5fd; font-size: 12px; }
		pre { white-space: pre-wrap; word-break: break-word; background: #0a0f1f; border: 1px solid #1e2a55; padding: 12px; border-radius: 8px; }
		a { color: #93c5fd; }
	</style>
</head>
<body>
	<div class="container">
		<div class="header">
			<h2>Adaptive Placement Agent</h2>
			<div class="small"><span id="status">Checking…</span> · <span id="authState">Logged out</span> <button id="logoutBtn" style="display:none;margin-left:8px">Logout</button></div>
		</div>

		<div class="card" id="login-card">
			<h3>Login</h3>
			<div class="row">
				<div>
					<label>Username</label>
					<input id="username" placeholder="username" value="" />
				</div>
				<div>
					<label>Password</label>
					<input id="password" type="password" placeholder="password" value="" />
				</div>
			</div>
			<div style="margin-top:12px">
				<button id="loginBtn">Login</button>
				<a id="registerLink" href="/register" style="margin-left:8px">Register</a>
				<span id="loginMsg" class="small" style="margin-left:8px"></span>
			</div>
		</div>

		<div class="card" id="gen-card" style="display:none">
			<h3>Personalized Chat</h3>
			<label>Prompt</label>
			<textarea id="prompt" rows="3">Hi there, I am here to talk.</textarea>
			<div style="margin-top:12px">
				<button id="genBtn">Generate</button>
			</div>
			<div style="margin-top:12px">
				<label>Response</label>
				<pre id="out"></pre>
			</div>
		</div>

		<div class="card">
			<h3>Reading (Adaptive)</h3>
			<div class="small">3 passages × 5 MCQs; starts at A2; CEFR A1–C2; KET/PET/FCE targets; uses Gemini 2.0 flash-lite.</div>
			<div style="margin-top:12px">
				<a href="/app/read/" target="_self">Open Reading Module</a>
			</div>
		</div>

		<div class="card">
			<h3>Vocabulary (Adaptive)</h3>
			<div class="small">15 MCQs; CEFR A1–C2; KET/PET/FCE targets; difficulty adapts by streak.</div>
			<div style="margin-top:12px">
				<a href="/app/vocabulary/" target="_self">Open Vocabulary Module</a>
			</div>
		</div>

		<div class="card">
			<h3>Listening (Adaptive)</h3>
			<div class="small">Audio comprehension tasks; CEFR A1–C2; adaptive difficulty.</div>
			<div style="margin-top:12px">
				<a href="/app/listen/" target="_self">Open Listening Module</a>
			</div>
		</div>

		<div class="card">
			<h3>Speaking (Adaptive)</h3>
			<div class="small">15 prompts; starts at A2; difficulty adapts; uses Gemini 2.5 flash-lite.</div>
			<div style="margin-top:12px">
				<a href="/app/speaking/" target="_self">Open Speaking Module</a>
			</div>
		</div>

		<div class="card">
			<h3>Writing</h3>
			<div class="small">1 prompt aligned to CEFR band; text or image input; OCR → LLM scoring on content, organization, language control, range; annotated feedback. Uses Gemini 2.5 flash-lite.</div>
			<div style="margin-top:12px">
				<a href="/app/write/" target="_self">Open Writing Module</a>
			</div>
		</div>

		<div class="card">
			<div class="small">Backend: <code>/health</code>, <code>/auth/token</code>, <code>/gemini/generate</code>. Front-end served at <code>/app</code>.</div>
		</div>
	</div>

	<script>
	const $ = (id) => document.getElementById(id);
	let token = localStorage.getItem('token');
	let username = localStorage.getItem('username');

	async function validateToken() {
		if (!token) return false;
		try {
			const r = await fetch('/auth/me', { headers: { 'Authorization': `Bearer ${token}` } });
			if (!r.ok) throw new Error('invalid');
			const u = await r.json().catch(() => null);
			if (u && u.username) { username = u.username; try { localStorage.setItem('username', username); } catch(_) {} }
			return true;
		} catch (_) {
			handleAuthFailure();
			return false;
		}
	}

	function updateAuthUI() {
		if (token) {
			$('authState').textContent = username ? `Logged in as ${username}` : 'Logged in';
			$('logoutBtn').style.display = 'inline-block';
			$('login-card').style.display = 'none';
			$('gen-card').style.display = 'block';
		} else {
			$('authState').textContent = 'Logged out';
			$('logoutBtn').style.display = 'none';
			$('login-card').style.display = 'block';
			$('gen-card').style.display = 'none';
		}
	}

	function handleAuthFailure() {
		token = null;
		username = null;
		try { localStorage.removeItem('token'); localStorage.removeItem('username'); } catch (_) {}
		updateAuthUI();
	}

	async function checkHealth() {
		try {
			const r = await fetch('/health');
			if (!r.ok) throw new Error('health failed');
			const j = await r.json();
			$('status').textContent = j.ok ? 'API: OK' : 'API: error';
		} catch (e) {
			$('status').textContent = 'API: unreachable';
		}
	}

	$('loginBtn').addEventListener('click', async () => {
		$('loginBtn').disabled = true; $('loginMsg').textContent = '…';
		try {
			const form = new URLSearchParams();
			form.set('username', $('username').value);
			form.set('password', $('password').value);
			const r = await fetch('/auth/token', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form });
			if (!r.ok) throw new Error('login failed');
			const j = await r.json();
			token = j.access_token;
			username = $('username').value || null;
			try { localStorage.setItem('token', token); if (username) localStorage.setItem('username', username); } catch (_) {}
			$('loginMsg').textContent = username ? `Logged in as ${username}` : 'Logged in';
			updateAuthUI();
		} catch (e) {
			$('loginMsg').textContent = 'Login failed';
		} finally {
			$('loginBtn').disabled = false;
		}
	});

	// Registration moved to /register; no handler here

	$('logoutBtn').addEventListener('click', () => {
		handleAuthFailure();
		$('loginMsg').textContent = '';
	});

	$('genBtn').addEventListener('click', async () => {
		$('genBtn').disabled = true; $('out').textContent = '…';
		try {
			const r = await fetch('/gemini/generate', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ prompt: $('prompt').value }) });
			if (r.status === 401) { handleAuthFailure(); throw new Error('Unauthorized'); }
			if (!r.ok) throw new Error('request failed');
			const j = await r.json();
			$('out').textContent = j && typeof j.text === 'string' ? j.text : '';
		} catch (e) {
			$('out').textContent = String(e);
		} finally {
			$('genBtn').disabled = false;
		}
	});

	(async () => { await validateToken(); updateAuthUI(); checkHealth(); })();
	</script>
</body>
</html>


