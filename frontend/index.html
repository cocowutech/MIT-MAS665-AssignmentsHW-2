<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Placement Agent</title>
	<style>
		body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; margin: 0; padding: 0; background: #0b1020; color: #f2f4f8; }
		.container { max-width: 820px; margin: 0 auto; padding: 24px; }
		.card { background: #111833; border: 1px solid #1e2a55; border-radius: 12px; padding: 20px; margin-top: 16px; }
		label { display: block; margin: 8px 0 4px; font-size: 14px; color: #c7d2fe; }
		input, textarea { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #e5e7eb; }
		button { background: #2563eb; color: white; border: none; padding: 10px 14px; border-radius: 8px; cursor: pointer; }
		button:disabled { opacity: 0.6; cursor: not-allowed; }
		.row { display: flex; gap: 12px; align-items: center; }
		.row > * { flex: 1; }
		.header { display: flex; justify-content: space-between; align-items: center; }
		.small { color: #93c5fd; font-size: 12px; }
		pre { white-space: pre-wrap; word-break: break-word; background: #0a0f1f; border: 1px solid #1e2a55; padding: 12px; border-radius: 8px; }
		a { color: #93c5fd; }
		.hidden { display: none !important; }
	</style>
</head>
<body>
	<div class="container">
		<div class="header">
			<h2>Adaptive Placement Agent</h2>
			<div class="small"><span id="status">Checking…</span> · <span id="authState">Logged out</span> <a id="loginLink" href="#login-card" style="margin-left:8px">Login</a></div>
		</div>

		<div class="card" id="login-card" data-auth-visible="guest">
			<h3>Login</h3>
			<form id="loginForm">
				<div class="row">
					<div>
						<label for="username">Username</label>
						<input id="username" name="username" placeholder="username" value="guest" required />
					</div>
					<div>
						<label for="password">Password</label>
						<input id="password" name="password" type="password" placeholder="password" value="any" required />
					</div>
				</div>
				<div style="margin-top:12px">
					<button type="submit">Login</button>
					<a id="registerLink" href="/register" style="margin-left:8px">Register</a>
					<span id="loginMsg" class="small" style="margin-left:8px"></span>
				</div>
			</form>
		</div>

		<div class="card hidden" id="gen-card" data-auth-visible="user">
			<h3>Personalized Chat</h3>
			
			<!-- ElevenLabs ConvAI Widget -->
			<div id="elevenlabs-widget" style="margin-bottom: 20px;">
				<elevenlabs-convai agent-id="agent_8301k73pseq7e2f8b6x2xs9bwbmr"></elevenlabs-convai>
				<script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>
			</div>
			
			<!-- Fallback Gemini Chat -->
			<div id="gemini-chat" style="display:none;">
				<label>Prompt</label>
				<textarea id="prompt" rows="3">Hi there, I am here to talk.</textarea>
				<div style="margin-top:12px">
					<button id="genBtn">Generate</button>
				</div>
				<div style="margin-top:12px">
					<label>Response</label>
					<pre id="out"></pre>
				</div>
			</div>
			
			<!-- Fallback Button -->
			<div style="margin-top:12px">
				<button id="fallbackBtn" onclick="toggleFallback()" style="display:none;">Use Gemini Chat Instead</button>
			</div>
		</div>

		<div class="card">
			<h3>Reading (Adaptive)</h3>
			<div class="small">3 passages × 5 MCQs, difficulty adapts by the passage results.</div>
			<div style="margin-top:12px">
				<a href="/app/read/" target="_self">Open Reading Module</a>
			</div>
		</div>

		<div class="card">
			<h3>Vocabulary (Adaptive)</h3>
			<div class="small">15 MCQs, difficulty adapts by streak.</div>
			<div style="margin-top:12px">
				<a href="/app/vocabulary/" target="_self">Open Vocabulary Module</a>
			</div>
		</div>

		<div class="card">
			<h3>Listening (Adaptive)</h3>
			<div class="small">5 x 2 MCQs, audio comprehension tasks with adaptive difficulty.</div>
			<div style="margin-top:12px">
				<a href="/app/listen/" target="_self">Open Listening Module</a>
			</div>
		</div>

		<div class="card">
			<h3>Speaking (Adaptive)</h3>
			<div class="small">15 prompts, difficulty adapts.</div>
			<div style="margin-top:12px">
				<a href="/app/speaking/" target="_self">Open Speaking Module</a>
			</div>
		</div>

		<div class="card">
			<h3>Writing</h3>
			<div class="small">1 prompt aligned to CEFR band; text or image input; OCR → LLM scoring on content, organization, language control, range; annotated feedback.</div>
			<div style="margin-top:12px">
				<a href="/app/write/" target="_self">Open Writing Module</a>
			</div>
		</div>
	</div>

	<script src="./build/shared/js/auth.js?v=20251022"></script>
	<script src="./build/shared/js/api.js?v=20251022"></script>
	<script>
	(function() {
		const $ = (id) => document.getElementById(id);

		function toggleFallback() {
			const elevenlabsWidget = document.getElementById('elevenlabs-widget');
			const geminiChat = document.getElementById('gemini-chat');
			const fallbackBtn = document.getElementById('fallbackBtn');

			if (!elevenlabsWidget || !geminiChat || !fallbackBtn) return;

			const showingFallback = elevenlabsWidget.style.display === 'none';
			elevenlabsWidget.style.display = showingFallback ? 'block' : 'none';
			geminiChat.style.display = showingFallback ? 'none' : 'block';
			fallbackBtn.textContent = showingFallback ? 'Use Gemini Chat Instead' : 'Use ElevenLabs Chat Instead';
		}

		function checkElevenLabsWidget() {
			setTimeout(() => {
				const convaiElement = document.querySelector('elevenlabs-convai');
				const hasShadowRoot = convaiElement && 'shadowRoot' in convaiElement && convaiElement.shadowRoot;
				if (!hasShadowRoot) {
					const fallbackBtn = document.getElementById('fallbackBtn');
					if (fallbackBtn) fallbackBtn.style.display = 'inline-block';
				}
			}, 3000);
		}

		async function checkHealth() {
			const statusEl = $('status');
			if (!statusEl) return;
			try {
				const response = await fetch('/health');
				if (!response.ok) throw new Error('health failed');
				const payload = await response.json();
				statusEl.textContent = payload.ok ? 'API: OK' : 'API: error';
			} catch (error) {
				statusEl.textContent = 'API: unreachable';
			}
		}

		async function handleLogin(event) {
			event.preventDefault();
			const form = event.currentTarget;
			if (!(form instanceof HTMLFormElement)) return;
			const submitBtn = form.querySelector('button[type="submit"]');
			const loginMsg = $('loginMsg');
			const usernameInput = $('username');
			const passwordInput = $('password');

			if (!(usernameInput instanceof HTMLInputElement) || !(passwordInput instanceof HTMLInputElement)) return;

			if (submitBtn instanceof HTMLButtonElement) submitBtn.disabled = true;
			if (loginMsg) loginMsg.textContent = '…';

			try {
				const result = await AuthUtils.authenticateUser(usernameInput.value, passwordInput.value);
				if (!result.success && loginMsg) {
					loginMsg.textContent = result.error || 'Login failed';
				}
			} catch (error) {
				if (loginMsg) loginMsg.textContent = 'Login failed';
			} finally {
				if (submitBtn instanceof HTMLButtonElement) submitBtn.disabled = false;
			}
		}

		async function handleGenerate(event) {
			event.preventDefault();
			const genBtn = event.currentTarget;
			if (!(genBtn instanceof HTMLButtonElement)) return;
			const promptInput = $('prompt');
			const output = $('out');
			if (!(promptInput instanceof HTMLTextAreaElement) || !output) return;

			genBtn.disabled = true;
			output.textContent = '…';

			try {
				const { token } = AuthUtils.getAuthState();
				const headers = { 'Content-Type': 'application/json' };
				if (token) headers['Authorization'] = `Bearer ${token}`;

				const response = await fetch('/gemini/generate', {
					method: 'POST',
					headers,
					body: JSON.stringify({ prompt: promptInput.value })
				});

				if (response.status === 401) {
					AuthUtils.clearAuth();
					throw new Error('Unauthorized');
				}

				if (!response.ok) {
					throw new Error('Request failed');
				}

				const payload = await response.json();
				output.textContent = payload && typeof payload.text === 'string' ? payload.text : '';
			} catch (error) {
				output.textContent = String(error);
			} finally {
				genBtn.disabled = false;
			}
		}

		function initializeAuthUI() {
			const loginForm = $('loginForm');
			if (loginForm) {
				loginForm.addEventListener('submit', handleLogin);
			}

			const genBtn = $('genBtn');
			if (genBtn) {
				genBtn.addEventListener('click', handleGenerate);
			}

			AuthUtils.onAuthChange((state) => {
				const loginMsg = $('loginMsg');
				if (loginMsg) {
					loginMsg.textContent = state.isAuthenticated
						? (state.username ? `Logged in as ${state.username}` : 'Logged in')
						: '';
				}
			});

			window.toggleFallback = toggleFallback;
		}

		async function initialize() {
			initializeAuthUI();
			await AuthUtils.initializeAuth();
			checkHealth();
			checkElevenLabsWidget();
		}

		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', initialize);
		} else {
			initialize();
		}
	})();
	</script>
</body>
</html>
