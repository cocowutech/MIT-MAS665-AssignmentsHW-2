<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Speaking (Adaptive)</title>
    <!--
    SPEAKING MODULE FRONTEND DOCUMENTATION
    =====================================
    
    This file implements the frontend interface for the adaptive speaking assessment module.
    It provides a complete speaking evaluation system with microphone recording, speech recognition,
    and real-time feedback integration with the backend API.
    
    BACKEND API INTEGRATION:
    - POST /auth/token: User authentication
    - POST /speaking/start: Initialize new speaking session
    - POST /speaking/answer: Submit speaking response for evaluation
    - POST /speaking/next: Get next task in current session
    - GET /auth/me: Validate current user token
    
    KEY FEATURES:
    - Microphone permission handling and audio recording
    - Real-time speech recognition (ASR) with transcript generation
    - Adaptive difficulty progression based on performance
    - Pronunciation assessment using Google Cloud Speech-to-Text
    - Session management with progress tracking
    - Guest user support for testing
    
    BROWSER COMPATIBILITY:
    - Requires modern browsers with MediaRecorder API support
    - Chrome/Firefox recommended for best speech recognition
    - HTTPS required for microphone access on non-localhost origins
    
    WORKFLOW:
    1. User logs in (guest/any for testing)
    2. Starts speaking session with initial CEFR level
    3. Prepares for speaking task (countdown timer)
    4. Records audio response with real-time transcription
    5. Submits response for LLM evaluation and pronunciation assessment
    6. Receives feedback and adaptive level adjustment
    7. Continues to next task or finishes session
    -->
    
    <!-- Shared CSS -->
    <link rel="stylesheet" href="../shared/css/base.css">
    <link rel="stylesheet" href="../shared/css/components.css">
    <!-- Module-specific CSS -->
    <link rel="stylesheet" href="styles.css">
    <!-- Shared JavaScript -->
    <script src="../shared/js/auth.js?v=20251026"></script>
    <script src="../shared/js/api.js?v=20251026"></script>
    <!-- Module-specific JavaScript -->
    <script src="speaking.js?v=20251026"></script>
    </head>
<body>
    <div class="container">
        <!-- Header with navigation and auth state -->
        <div class="header">
            <h1>Speaking Assessment (Adaptive)</h1>
            <div class="small">
                <a href="/app">Home</a> · 
                <span id="authState">Logged out</span> 
                <a href="/app" id="loginLink">Login</a>
            </div>
        </div>

        <!-- Back navigation card -->
        <div class="card">
            <button onclick="window.location.href = '/app/';">← Back</button>
        </div>

        <div id="status" class="small"></div>

        <!-- Login Form -->
        <div id="login-card" class="card">
            <h2>Login</h2>
            <form id="loginForm">
            <div class="row">
                <div>
                        <label for="username">Username</label>
                        <input id="username" type="text" placeholder="username" value="guest" required>
                    </div>
                    <div>
                        <label for="password">Password</label>
                        <input id="password" type="password" placeholder="password" value="any" required>
                    </div>
                </div>
                <div style="margin-top:12px">
                    <button type="submit">Login</button>
                </div>
            </form>
        </div>

        <!-- Main Interface -->
        <div id="session-card" class="hidden">
            <div class="card">
                <h2>Speaking Assessment</h2>
                <p>This assessment will evaluate your speaking skills through various tasks.</p>
                <p>You will have preparation time before each recording, and the system will provide real-time feedback.</p>
                
                <div class="level-indicator">
                    <span>Starting Level:</span>
                    <span class="level-badge">A2</span>
            </div>
                
                <button id="startBtn">Start Speaking Assessment</button>
            </div>
        </div>

        <!-- Task Interface -->
        <div id="taskInterface" class="hidden">
            <div class="card">
                <div class="speaking-progress">
                    <span class="progress-text">Task Progress</span>
                    <span id="taskProgress">1/5</span>
            </div>

                <div class="speaking-prompt">
                    <div class="prompt-title">Speaking Task</div>
                    <div id="promptText" class="prompt-text"></div>
                    <div id="promptInstructions" class="prompt-instructions"></div>
            </div>

                <!-- Preparation Phase -->
                <div id="prep" class="hidden">
                    <div class="timer-display preparation">
                        <div>Preparation Time</div>
                        <div id="prepTimer" class="timer">30</div>
                    </div>
                    <p>Prepare your response. Recording will start automatically.</p>
                </div>

                <!-- Recording Phase -->
                <div id="record" class="hidden">
                    <div class="timer-display recording">
                        <div>Recording Time</div>
                        <div id="recordTimer" class="timer">60</div>
            </div>

                    <div class="recording-controls">
                    <button id="recordBtn">Start</button>
                        <div class="recording-status">
                            <div class="recording-dot"></div>
                            <span>Recording...</span>
                        </div>
                    </div>
                    
                    <div class="audio-visualizer" id="audioVisualizer">
                        <!-- Audio visualization bars will be added dynamically -->
                    </div>
                    
                    <div class="transcript-display">
                        <div>Live Transcript:</div>
                        <div id="transcript"></div>
                    </div>
                    
                    <!-- Custom Audio Player -->
                    <div id="audioPlayer" class="audio-player hidden">
                        <div class="audio-player-header">
                            <span>Your Recording</span>
                        </div>
                        <audio id="audioPlayback" preload="metadata"></audio>
                        <div class="audio-controls">
                            <button id="playBtn" class="audio-btn">
                                <span>▶</span>
                            </button>
                            <button id="pauseBtn" class="audio-btn hidden">
                                <span>⏸</span>
                            </button>
                            <button id="restartBtn" class="audio-btn">
                                <span>⏮</span>
                            </button>
                            <div class="audio-progress">
                                <div class="audio-progress-bar">
                                    <div id="audioProgress" class="audio-progress-fill"></div>
                                </div>
                                <div class="audio-time">
                                    <span id="currentTime">0:00</span>
                                    <span id="duration">0:00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="asrWarning" class="small" style="color: #fbbf24; margin-top: 8px;"></div>
            </div>
        </div>

        <!-- Results Display -->
        <div id="results" class="hidden">
            <!-- Evaluation results will be displayed here -->
        </div>

        <!-- Hidden form for submission -->
        <div class="hidden">
                <input id="itemId" type="hidden" />
            </div>

            <div id="review" class="hidden" style="margin-top:12px;">
                <div class="small">Review</div>
                <div id="reviewSummary" style="margin-top:6px"></div>
                <div id="reviewFeedback" class="small" style="min-height:20px; margin-top:4px"></div>
                <div class="small" style="margin-top:8px">Pronunciation Score</div>
                <div id="reviewPronunciationScore" class="small" style="min-height:20px; margin-top:4px"></div>
                <div class="small" style="margin-top:8px">Pronunciation Feedback</div>
                <div id="reviewPronunciationFeedback" class="small" style="min-height:20px; margin-top:4px"></div>
            </div>
        
        <div class="card hidden" id="nextCard" style="margin-top:12px;">
            <div class="row" style="justify-content:flex-end">
                <button id="continueBtn">Next Assignment</button>
            </div>
            <div class="hidden" style="margin-top: 16px;" id="finishSessionBtnContainer">
                <button onclick="window.location.href = '/app/';">Session finished — back to home</button>
            </div>
        </div>
    </div>
</body>
</html>