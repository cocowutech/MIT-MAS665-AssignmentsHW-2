<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Speaking (Adaptive)</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; margin: 0; padding: 0; background: #0b1020; color: #f2f4f8; }
        .container { max-width: 820px; margin: 0 auto; padding: 24px; }
        .card { background: #111833; border: 1px solid #1e2a55; border-radius: 12px; padding: 20px; margin-top: 16px; }
        label { display: block; margin: 8px 0 4px; font-size: 14px; color: #c7d2fe; }
        input, textarea { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #e5e7eb; }
        button { background: #2563eb; color: white; border: none; padding: 10px 14px; border-radius: 8px; cursor: pointer; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .row { display: flex; gap: 12px; align-items: center; }
        .row > * { flex: 1; }
        .small { color: #93c5fd; font-size: 12px; }
        .timer { font-variant-numeric: tabular-nums; }
        audio { width: 100%; margin-top: 8px; }
        .header { display: flex; justify-content: space-between; align-items: center; }
        a { color: #93c5fd; }
    </style>
    <script>
        const $ = (id) => document.getElementById(id);
        let token = localStorage.getItem('token');
        let username = localStorage.getItem('username');
        let mediaRecorder = null;
        let recordedChunks = [];
        let countdownInterval = null;
        let recognition = null;
        let isRecording = false;
        let hasRecordedThisItem = false;
        let transcriptText = '';
        let submitTriggered = false;
        let asrFinalText = '';
        let session = null;

        async function login(username, password){
            const form = new URLSearchParams();
            form.set('username', username);
            form.set('password', password);
            const r = await fetch('/auth/token', { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body: form });
            if(!r.ok) throw new Error('login failed');
            const j = await r.json();
            try { localStorage.setItem('token', j.access_token); if (username) localStorage.setItem('username', username); } catch(_) {}
            return j.access_token;
        }

        async function startSession(){
            const r = await fetch('/speaking/start', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ start_level: 'A2' }) });
            if(!r.ok) throw new Error('start failed');
            return await r.json();
        }

        function msToS(ms){ return Math.max(0, Math.ceil(ms/1000)); }

        function cleanTranscript(text){
            let s = (text || '').replace(/\s+/g, ' ').trim();
            if(!s) return s;
            const patterns = [
                [/(\b\w+\s+\w+\s+\w+)(?:\s+\1\b)+/gi, '$1'],
                [/(\b\w+\s+\w+)(?:\s+\1\b)+/gi, '$1'],
                [/(\b\w+)(?:\s+\1\b)+/gi, '$1'],
            ];
            for (const [pat, rep] of patterns) { s = s.replace(pat, rep); }
            return s.replace(/\s+/g, ' ').trim();
        }

        async function startPrepAndRecord(prepSeconds, recordSeconds){
            $('prepTimer').textContent = prepSeconds;
            $('recordTimer').textContent = Math.min(recordSeconds, 60);
            $('prep').style.display = 'block';
            $('record').style.display = 'none';
            isRecording = false;
            hasRecordedThisItem = false;
            transcriptText = '';
            submitTriggered = false;
            $('audioPlayback').src = '';
            $('recordBtn').textContent = 'Start';
            $('recordBtn').disabled = false;

            if(countdownInterval) clearInterval(countdownInterval);
            let remaining = prepSeconds;
            countdownInterval = setInterval(() => {
                remaining -= 1;
                $('prepTimer').textContent = remaining;
                if(remaining <= 0){
                    clearInterval(countdownInterval);
                    // Reveal recording controls and start 5s auto-start countdown
                    showRecordUI(parseInt($('recordTimer').textContent, 10) || 60);
                }
            }, 1000);
        }

        function initASR(){
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!SR){
                const warn = $('asrWarning');
                if(warn) warn.textContent = 'Speech recognition not supported in this browser.';
                return null;
            }
            const r = new SR();
            r.lang = 'en-US';
            r.interimResults = true;
            r.continuous = true;
            r.onresult = (event) => {
                let interimText = '';
                for(let i = event.resultIndex; i < event.results.length; i++){
                    const res = event.results[i];
                    if(res.isFinal){ asrFinalText += res[0].transcript + ' '; }
                    else { interimText += res[0].transcript; }
                }
                transcriptText = (asrFinalText + interimText).trim();
                const t = $('transcript'); if(t) t.textContent = cleanTranscript(transcriptText);
            };
            r.onerror = () => {};
            r.onend = () => {
                // Manual submit required; no auto-submit on ASR end
            };
            return r;
        }

        async function beginRecording(recordSeconds){
            $('prep').style.display = 'none';
            $('record').style.display = 'block';
            $('recordBtn').textContent = 'Stop';
            $('recordBtn').disabled = false;
            isRecording = true;
            const as = $('autostart'); if (as) as.style.display = 'none';
            transcriptText = '';
            asrFinalText = '';
            recordedChunks = [];
            const subBtnHide = $('submitBtn'); if (subBtnHide) subBtnHide.style.display = 'none';
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = (e) => { if(e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                $('audioPlayback').src = URL.createObjectURL(blob);
                // Reveal Submit button after recording stops
                const sub = $('submitBtn'); if (sub) sub.style.display = 'inline-block';
            };
            mediaRecorder.start();

            let remaining = parseInt($('recordTimer').textContent, 10) || 60;
            if(countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                remaining -= 1;
                $('recordTimer').textContent = remaining;
                if(remaining <= 0){ stopRecording(); }
            }, 1000);

            if(!recognition){ recognition = initASR(); }
            try{ if(recognition) recognition.start(); } catch(_) {}
        }

        function stopRecording(){
            if(countdownInterval) clearInterval(countdownInterval);
            if(mediaRecorder && mediaRecorder.state !== 'inactive'){
                mediaRecorder.stop();
            }
            try{ if(recognition) recognition.stop(); } catch(_) {}
            isRecording = false;
            hasRecordedThisItem = true;
            $('recordBtn').textContent = 'Start';
            // Disable to prevent re-recording
            $('recordBtn').disabled = true;
            // Show Submit button; user must submit manually
            const sub = $('submitBtn'); if (sub) sub.style.display = 'inline-block';
        }

        async function submitAnswer(sessionId, itemId, transcript){
            const r = await fetch('/speaking/answer', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ session_id: sessionId, item_id: itemId, transcript: transcript }) });
            if(!r.ok){
                const msg = await r.text().catch(() => 'submit failed');
                throw new Error(msg || 'submit failed');
            }
            return await r.json();
        }

        function toggleRecording(){
            if(hasRecordedThisItem) return;
            if(!isRecording){
                if(countdownInterval) clearInterval(countdownInterval);
                const as = $('autostart'); if (as) as.style.display = 'none';
                beginRecording(parseInt($('recordTimer').textContent, 10) || 60);
            }else{
                stopRecording();
            }
        }

        function showRecordUI(recordSeconds){
            $('prep').style.display = 'none';
            $('record').style.display = 'block';
            $('recordBtn').textContent = 'Start';
            $('recordBtn').disabled = false;
            const subBtn = $('submitBtn'); if (subBtn) subBtn.style.display = 'none';
            const as = $('autostart');
            const ast = $('autostartTimer');
            if (as && ast) {
                let remain = 5;
                ast.textContent = remain;
                as.style.display = 'block';
                if (countdownInterval) clearInterval(countdownInterval);
                countdownInterval = setInterval(() => {
                    if (isRecording) { clearInterval(countdownInterval); return; }
                    remain -= 1;
                    ast.textContent = remain;
                    if (remain <= 0){
                        clearInterval(countdownInterval);
                        beginRecording(recordSeconds);
                    }
                }, 1000);
            }
        }

        async function attemptSubmit(){
            if (submitTriggered) return;
            submitTriggered = true;
            const text = (transcriptText || '').trim();
            const cleaned = cleanTranscript(text);
            if (!cleaned) {
                const warn = $('asrWarning');
                if (warn) warn.textContent = 'No transcript captured. Please ensure microphone and speech recognition permissions are granted and use a supported browser (Chrome).';
            }
            try{
                const resp = await submitAnswer($('sessionId').value, $('itemId').value, cleaned);
                handleAnswer(resp);
            }catch(e){
                alert(String(e.message || e));
            }
        }

        function handleAnswer(resp){
            const predicted = resp && resp.predicted_level ? String(resp.predicted_level).toUpperCase() : null;
            $('status').textContent = predicted ? `Level: ${resp.level} (${resp.progress_current}/${resp.progress_total}) · Estimated: ${predicted}` : `Level: ${resp.level} (${resp.progress_current}/${resp.progress_total})`;
            $('feedback').textContent = resp.feedback || '';
            if(resp.finished){
                $('prompt').textContent = 'Finished!';
                $('guidance').textContent = '';
                $('prep').style.display = 'none';
                $('record').style.display = 'none';
                return;
            }
            const item = resp.item;
            $('prompt').textContent = item.prompt;
            $('guidance').textContent = item.guidance || '';
            $('audioPlayback').src = '';
            $('sessionId').value = session.session_id;
            $('itemId').value = item.id;
            startPrepAndRecord(item.prep_seconds, item.record_seconds);
            const sub = $('submitBtn'); if (sub) { sub.style.display = 'none'; sub.disabled = false; }
        }

        window.addEventListener('DOMContentLoaded', async () => {
            if (token) {
                $('module').style.display = 'block';
                const st = document.getElementById('authState'); const link = document.getElementById('loginLink');
                if (st) { st.textContent = username ? `Logged in as ${username}` : 'Logged in'; }
                if (link) { link.style.display = 'none'; }
                const lc = document.getElementById('login-card'); if (lc) lc.style.display = 'none';
            }
            $('loginBtn').addEventListener('click', async () => {
                $('loginBtn').disabled = true; $('loginMsg').textContent = '…';
                try{
                    token = await login($('username').value, $('password').value);
                    username = $('username').value || localStorage.getItem('username');
                    $('loginMsg').textContent = 'Logged in';
                    $('module').style.display = 'block';
                    const st = document.getElementById('authState'); const link = document.getElementById('loginLink');
                    if (st) { st.textContent = username ? `Logged in as ${username}` : 'Logged in'; }
                    if (link) { link.style.display = 'none'; }
                    const lc = document.getElementById('login-card'); if (lc) lc.style.display = 'none';
                }catch(e){
                    $('loginMsg').textContent = 'Login failed';
                }finally{
                    $('loginBtn').disabled = false;
                }
            });

            $('startBtn').addEventListener('click', async () => {
                $('startBtn').disabled = true; $('status').textContent = 'Starting…';
                try{
                    session = await startSession();
                    $('status').textContent = `Level: ${session.level} (${session.progress_current}/${session.progress_total})`;
                    $('prompt').textContent = session.item.prompt;
                    $('guidance').textContent = session.item.guidance || '';
                    $('audioPlayback').src = '';
                    $('feedback').textContent = '';
                    $('recordBtn').onclick = toggleRecording;
                    const sub = $('submitBtn'); if (sub) { sub.style.display = 'none'; sub.disabled = false; }
                    await startPrepAndRecord(session.item.prep_seconds, session.item.record_seconds);
                    $('sessionId').value = session.session_id;
                    $('itemId').value = session.item.id;
                }catch(e){
                    $('status').textContent = 'Failed to start session';
                }finally{
                    $('startBtn').disabled = false;
                }
            });

            const skipBtn = document.getElementById('skipPrepBtn');
            if (skipBtn) {
                skipBtn.addEventListener('click', () => {
                    if(countdownInterval) clearInterval(countdownInterval);
                    showRecordUI(parseInt($('recordTimer').textContent, 10) || 60);
                });
            }

            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.addEventListener('click', async () => {
                    submitBtn.disabled = true;
                    try { await attemptSubmit(); } finally { submitBtn.disabled = false; }
                });
            }
        });
    </script>
    </head>
<body>
    <div class="container">
        <div class="header">
            <h2>Speaking (Adaptive)</h2>
            <div class="small"><a href="/app/">Home</a> · <span id="authState">Logged out</span> <a href="/app/" id="loginLink">Login</a></div>
        </div>
        <div class="card">
            <button onclick="window.location.href = '/app/';">← Back</button>
        </div>
        <div class="card" id="login-card">
            <h3>Login</h3>
            <div class="row">
                <div>
                    <label>Username</label>
                    <input id="username" placeholder="username" value="rong_wu" />
                </div>
                <div>
                    <label>Password</label>
                    <input id="password" type="password" placeholder="password" value="mit!23456" />
                </div>
            </div>
            <div style="margin-top:12px">
                <button id="loginBtn">Login</button>
                <span id="loginMsg" class="small" style="margin-left:8px"></span>
            </div>
        </div>

        <div id="module" class="card" style="display:none">
            <div class="row" style="justify-content: space-between;">
                <div id="status" class="small">Not started</div>
                <button id="startBtn">Start Session</button>
            </div>

            <div style="margin-top:12px">
                <div class="small">Prompt</div>
                <div id="prompt" style="margin-top:6px"></div>
                <div id="guidance" class="small" style="margin-top:8px"></div>
            </div>

            <div id="prep" style="margin-top:12px; display:none">
                <div>Preparation… <span class="timer" id="prepTimer">30</span>s</div>
                <div class="row" style="margin-top:8px">
                    <button id="skipPrepBtn">Skip to recording</button>
                </div>
            </div>

            <div id="record" style="margin-top:12px; display:none">
                <div>Recording… <span class="timer" id="recordTimer">60</span>s</div>
                <div id="autostart" class="small" style="margin-top:4px; display:none">Auto-starting in <span class="timer" id="autostartTimer">5</span>s…</div>
                <div id="asrWarning" class="small" style="margin-top:4px"></div>
                <div class="row" style="margin-top:8px">
                    <button id="recordBtn">Start</button>
                    <button id="submitBtn" style="display:none">Submit</button>
                </div>
                <audio id="audioPlayback" controls></audio>
                <div class="small" style="margin-top:8px">Transcript</div>
                <div id="transcript" class="small" style="min-height:20px; margin-top:4px"></div>
                <div class="small" style="margin-top:8px">Feedback</div>
                <div id="feedback" class="small" style="min-height:20px; margin-top:4px"></div>
                <input id="sessionId" type="hidden" />
                <input id="itemId" type="hidden" />
            </div>
        </div>
    </div>
</body>
</html>



