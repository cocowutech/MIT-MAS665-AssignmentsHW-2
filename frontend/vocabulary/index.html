<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vocabulary Module</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; margin: 0; padding: 0; background: #0b1020; color: #f2f4f8; }
        .container { max-width: 820px; margin: 0 auto; padding: 24px; }
        .card { background: #111833; border: 1px solid #1e2a55; border-radius: 12px; padding: 20px; margin-top: 16px; }
        label { display: block; margin: 8px 0 4px; font-size: 14px; color: #c7d2fe; }
        input, select { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #e5e7eb; }
        button { background: #2563eb; color: white; border: none; padding: 10px 14px; border-radius: 8px; cursor: pointer; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .row { display: flex; gap: 12px; align-items: center; }
        .row > * { flex: 1; }
        .header { display: flex; justify-content: space-between; align-items: center; }
        .small { color: #93c5fd; font-size: 12px; }
        .passage { white-space: pre-wrap; word-break: break-word; background: #0a0f1f; border: 1px solid #1e2a55; padding: 12px; border-radius: 8px; }
        .option { background: #0f172a; border: 1px solid #1e2a55; padding: 10px; border-radius: 8px; cursor: pointer; }
        .option.selected { border-color: #2563eb; }
        .option.correct { border-color: #16a34a; }
        .option.incorrect { border-color: #dc2626; }
        a { color: #93c5fd; }
    </style>
    <link rel="icon" href="data:," />
    <base href="/app/" />
    <script defer>
        const $ = (id) => document.getElementById(id);
        let token = null;
        let sessionId = null;
        let currentQuestionId = null;
        let currentAnswerIndex = null;

        async function login(username, password) {
            const form = new URLSearchParams();
            form.set('username', username);
            form.set('password', password);
            const r = await fetch('/auth/token', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form });
            if (!r.ok) throw new Error('login failed');
            const j = await r.json();
            token = j.access_token;
        }

        async function startSession(startLevel) {
            const r = await fetch('/vocabulary/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ start_level: startLevel })
            });
            if (!r.ok) throw new Error('start failed');
            const j = await r.json();
            sessionId = j.session_id;
            renderQuestion(j);
        }

        function renderQuestion(payload) {
            $('meta').textContent = `Level: ${payload.level} • ${payload.progress_current}/${payload.progress_total}`;
            const q = payload.question;
            currentQuestionId = q.id;
            currentAnswerIndex = q.answer_index;
            $('passage').textContent = q.passage;
            $('qtext').textContent = q.question;
            const opts = $('options');
            opts.innerHTML = '';
            q.options.forEach((opt, idx) => {
                const div = document.createElement('div');
                div.className = 'option';
                div.textContent = opt;
                div.onclick = () => selectOption(idx);
                opts.appendChild(div);
            });
            $('feedback').textContent = '';
            $('submitBtn').disabled = true;
            $('nextBtn').style.display = 'none';
            $('submitBtn').style.display = 'inline-block';
        }

        let selectedIndex = null;
        function selectOption(idx) {
            selectedIndex = idx;
            Array.from(document.querySelectorAll('.option')).forEach((el, i) => {
                el.classList.toggle('selected', i === idx);
            });
            $('submitBtn').disabled = false;
        }

        async function submitAnswer() {
            $('submitBtn').disabled = true;
            try {
                const r = await fetch('/vocabulary/answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ session_id: sessionId, question_id: currentQuestionId, choice_index: selectedIndex })
                });
                const j = await r.json();
                if (!r.ok) throw new Error(j.detail || 'answer failed');
                $('meta').textContent = `Level: ${j.level} • ${j.progress_current}/${j.progress_total}`;
                $('feedback').textContent = (j.correct ? 'Correct. ' : 'Incorrect. ') + (j.explanation || '');
                const opts = document.querySelectorAll('.option');
                opts.forEach((el, i) => {
                    el.classList.remove('selected');
                    if (i === currentAnswerIndex) el.classList.add('correct');
                    if (i === selectedIndex && !j.correct) el.classList.add('incorrect');
                });

                if (j.finished) {
                    $('submitBtn').style.display = 'none';
                    $('nextBtn').style.display = 'inline-block';
                    $('nextBtn').textContent = 'Session finished — back to home';
                    $('nextBtn').onclick = () => { window.location.href = '/app/'; };
                } else if (j.question) {
                    $('nextBtn').style.display = 'inline-block';
                    $('nextBtn').textContent = 'Next';
                    $('nextBtn').onclick = () => { renderQuestion({ level: j.level, progress_current: j.progress_current, progress_total: j.progress_total, question: j.question }); };
                }
            } catch (e) {
                $('feedback').textContent = String(e);
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            $('loginBtn').addEventListener('click', async () => {
                $('loginBtn').disabled = true; $('loginMsg').textContent = '…';
                try {
                    await login($('username').value, $('password').value);
                    $('loginMsg').textContent = 'Logged in';
                    $('startCard').style.display = 'block';
                } catch (e) {
                    $('loginMsg').textContent = 'Login failed';
                } finally {
                    $('loginBtn').disabled = false;
                }
            });

            $('startBtn').addEventListener('click', async () => {
                $('startBtn').disabled = true; $('startMsg').textContent = '…';
                try {
                    await startSession($('startLevel').value);
                    $('sessionCard').style.display = 'block';
                } catch (e) {
                    $('startMsg').textContent = 'Start failed';
                } finally {
                    $('startBtn').disabled = false;
                }
            });

            $('submitBtn').addEventListener('click', submitAnswer);
        });
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>Vocabulary (Adaptive)</h2>
            <div id="meta" class="small">Ready</div>
        </div>

        <div class="card">
            <a href="/app/">← Back</a>
        </div>

        <div class="card" id="loginCard">
            <h3>Login</h3>
            <div class="row">
                <div>
                    <label>Username</label>
                    <input id="username" placeholder="username" value="rong_wu" />
                </div>
                <div>
                    <label>Password</label>
                    <input id="password" type="password" placeholder="password" value="mit!23456" />
                </div>
            </div>
            <div style="margin-top:12px">
                <button id="loginBtn">Login</button>
                <span id="loginMsg" class="small" style="margin-left:8px"></span>
            </div>
        </div>

        <div class="card" id="startCard" style="display:none">
            <h3>Start Session</h3>
            <div class="row">
                <div>
                    <label>Start Level (A1–C2)</label>
                    <select id="startLevel">
                        <option>A1</option>
                        <option selected>A2</option>
                        <option>B1</option>
                        <option>B2</option>
                        <option>C1</option>
                        <option>C2</option>
                    </select>
                </div>
            </div>
            <div style="margin-top:12px">
                <button id="startBtn">Start</button>
                <span id="startMsg" class="small" style="margin-left:8px"></span>
            </div>
        </div>

        <div class="card" id="sessionCard" style="display:none">
            <h3>Question</h3>
            <div class="small">Passage</div>
            <div id="passage" class="passage"></div>
            <div style="height:8px"></div>
            <div id="qtext"></div>
            <div id="options" style="display:grid; gap:8px; margin-top:12px"></div>
            <div style="margin-top:12px">
                <button id="submitBtn" disabled>Submit</button>
                <button id="nextBtn" style="display:none">Next</button>
            </div>
            <div id="feedback" class="small" style="margin-top:8px"></div>
        </div>
    </div>
</body>
<!--
Served at /app/vocabulary/ (and usually at /app/vocabulary via redirect).
-->
</html>


