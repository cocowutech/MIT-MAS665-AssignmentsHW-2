<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Writing Task</title>
	<style>
		body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; margin: 0; padding: 0; background: #0b1020; color: #f2f4f8; }
		.container { max-width: 920px; margin: 0 auto; padding: 24px; }
		.card { background: #111833; border: 1px solid #1e2a55; border-radius: 12px; padding: 20px; margin-top: 16px; }
		label { display: block; margin: 8px 0 4px; font-size: 14px; color: #c7d2fe; }
		input, textarea, select { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #e5e7eb; }
		button { background: #2563eb; color: white; border: none; padding: 10px 14px; border-radius: 8px; cursor: pointer; }
		button:disabled { opacity: 0.6; cursor: not-allowed; }
		.row { display: flex; gap: 12px; align-items: center; }
		.row > * { flex: 1; }
		.small { color: #93c5fd; font-size: 12px; }
		pre { white-space: pre-wrap; word-break: break-word; background: #0a0f1f; border: 1px solid #1e2a55; padding: 12px; border-radius: 8px; }
		a { color: #93c5fd; }
		.inline-annot { background: #062b2b; border-left: 3px solid #0ea5e9; padding: 6px 8px; margin: 6px 0; }
		/* Prompt box enhancements */
		.prompt-box { background: #0a0f1f; border: 1px solid #22305f; border-radius: 12px; padding: 16px; }
		.prompt-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
		.prompt-title { font-size: 16px; font-weight: 600; }
		.meta { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }
		.meta-item { background: #0f1a39; border: 1px solid #2a3a76; color: #c7d2fe; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
		.chips { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
		.chip { display: inline-block; padding: 4px 8px; border-radius: 999px; background: #0b1837; border: 1px solid #1e2a55; color: #93c5fd; font-size: 12px; }
		.chip.struct { color: #a7f3d0; border-color: #115e59; background: #062b2b; }
		.section-title { font-weight: 600; color: #c7d2fe; margin-top: 12px; margin-bottom: 6px; font-size: 13px; }
		.prompt-body p { margin: 6px 0; }
		.prompt-body ul, .prompt-body ol { margin: 6px 0 6px 20px; }
		.small-btn { background: #0f172a; border: 1px solid #334155; color: #e5e7eb; padding: 6px 10px; border-radius: 8px; font-size: 12px; }
		/* Graph visualization */
		#promptGraph { width: 100%; height: 260px; background: #0a0f1f; border: 1px dashed #22305f; border-radius: 12px; margin-top: 12px; position: relative; overflow: hidden; }
		.graph-node { position: absolute; padding: 8px 10px; border-radius: 10px; border: 1px solid #1e2a55; background: #121a33; color: #c7d2fe; font-size: 12px; text-align: center; }
		.graph-node.core { background: #0b1837; }
		.graph-link { position: absolute; background: #1e2a55; height: 2px; transform-origin: 0 0; }
	</style>
</head>
<body>
	<div class="container">
		<div style="display:flex; justify-content: space-between; align-items: center;">
			<h2>Writing Task</h2>
			<div class="small"><a href="/app" class="small">Home</a> · <span id="authState">Logged out</span> <a href="/app" id="loginLink" class="small">Login</a></div>
		</div>

		<div class="card">
			<button onclick="window.location.href = '/app/';">← Back</button>
		</div>

		<div class="card" id="auth-card">
			<h3>Authenticate</h3>
			<div class="row">
				<div>
					<label>Username</label>
					<input id="username" placeholder="username" value="rong_wu" />
				</div>
				<div>
					<label>Password</label>
					<input id="password" type="password" placeholder="password" value="mit!23456" />
				</div>
			</div>
			<div style="margin-top:12px">
				<button id="loginBtn">Login</button>
				<span id="loginMsg" class="small" style="margin-left:8px"></span>
			</div>
		</div>

		<div class="card" id="prompt-card" style="display:none">
			<h3>Generate Prompt</h3>
			<div class="row">
				<div>
					<label>CEFR Band</label>
					<select id="band">
						<option value="A1">A1</option>
						<option value="A2">A2</option>
						<option value="B1" selected>B1</option>
						<option value="B2">B2</option>
						<option value="C1">C1</option>
						<option value="C2">C2</option>
					</select>
				</div>
				<div>
					<label>Topic (optional)</label>
					<input id="topic" placeholder="e.g., travel, school, hobbies" />
				</div>
			</div>
			<div style="margin-top:12px">
				<button id="genPromptBtn">Generate Prompt</button>
			</div>
			<div style="margin-top:12px">
				<label>Prompt</label>
				<div id="promptNice" class="prompt-box" style="display:none"></div>
				<div id="promptGraph" style="display:none"></div>
				<pre id="promptOut" style="display:none"></pre>
				<div class="small" id="targetsOut" style="display:none"></div>
			</div>
		</div>

		<div class="card" id="write-card" style="display:none">
			<h3>Write or Upload</h3>
			<label>Your Writing</label>
			<textarea id="essay" rows="8" placeholder="Type your response here or upload an image below..."></textarea>
			<div class="row" style="margin-top:12px">
				<button id="scoreTextBtn">Score Text</button>
				<input type="file" id="imageFile" accept="image/*" />
				<button id="scoreImageBtn">OCR + Score Image</button>
			</div>
		</div>

		<div class="card" id="result-card" style="display:none">
			<h3>Result</h3>
			<div id="bandOut" class="small"></div>
			<pre id="resultOut"></pre>
			<div id="inlineOut"></div>
		</div>
	</div>

	<script>
	const $ = (id) => document.getElementById(id);
	let token = localStorage.getItem('token');
	let username = localStorage.getItem('username');
	let lastBand = 'B1';

	function escapeHTML(str) {
		return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));
	}

	function recommendedWordRange(band) {
		const B = (band || 'B1').toUpperCase();
		switch (B) {
			case 'A1': return '60–90 words';
			case 'A2': return '80–120 words';
			case 'B1': return '100–160 words';
			case 'B2': return '140–200 words';
			case 'C1': return '180–240 words';
			case 'C2': return '220–280 words';
			default: return '100–160 words';
		}
	}

	function formatPromptHTML(text) {
		const lines = String(text || '').split(/\r?\n/);
		let html = '';
		let listType = null; // 'ul' | 'ol' | null
		for (const raw of lines) {
			const line = raw.trim();
			if (line === '') {
				if (listType) { html += listType === 'ol' ? '</ol>' : '</ul>'; listType = null; }
				html += '<br/>';
				continue;
			}
			if (/^\d+\./.test(line)) {
				if (listType !== 'ol') { if (listType) { html += listType === 'ol' ? '</ol>' : '</ul>'; } html += '<ol>'; listType = 'ol'; }
				html += `<li>${escapeHTML(line.replace(/^\d+\.\s*/, ''))}</li>`;
				continue;
			}
			if (/^[-•\u2022]/.test(line)) {
				if (listType !== 'ul') { if (listType) { html += listType === 'ol' ? '</ol>' : '</ul>'; } html += '<ul>'; listType = 'ul'; }
				html += `<li>${escapeHTML(line.replace(/^[-•\u2022]\s*/, ''))}</li>`;
				continue;
			}
			if (listType) { html += listType === 'ol' ? '</ol>' : '</ul>'; listType = null; }
			html += `<p>${escapeHTML(line)}</p>`;
		}
		if (listType) { html += listType === 'ol' ? '</ol>' : '</ul>'; }
		return html;
	}

	function renderPromptBox(data) {
		const band = (data && data.band) ? data.band : ($('band').value || 'B1');
		const examTask = data && data.exam_task ? data.exam_task : 'Task';
		const promptText = data && data.prompt ? data.prompt : 'Prompt not available';
		const targets = (data && data.targets) ? data.targets : {};
		const vocab = Array.isArray(targets.target_vocab) ? targets.target_vocab : [];
		const structures = Array.isArray(targets.target_structures) ? targets.target_structures : [];
		const words = recommendedWordRange(band);
		const chipsHTML = [...vocab.map(v=>`<span class="chip">${escapeHTML(v)}</span>`), ...structures.map(s=>`<span class="chip struct">${escapeHTML(s)}</span>`)].join('');
		$('promptNice').innerHTML = `
			<div class="prompt-header">
				<div>
					<div class="prompt-title">Your Writing Prompt</div>
					<div class="meta">
						<span class="meta-item">Band ${escapeHTML(band)}</span>
						<span class="meta-item">Task: ${escapeHTML(examTask)}</span>
						<span class="meta-item">Aim: ${escapeHTML(words)}</span>
					</div>
				</div>
				<button class="small-btn" id="copyPromptBtn">Copy</button>
			</div>
			<div class="prompt-body">${formatPromptHTML(promptText)}</div>
			${chipsHTML ? `<div class="section-title">Targets</div><div class="chips">${chipsHTML}</div>` : ''}
			<div class="section-title">Instructions</div>
			<ul class="small">
				<li>Address all parts of the task.</li>
				<li>Organize into clear paragraphs and use linking words.</li>
				<li>Use varied vocabulary and structures appropriate to Band ${escapeHTML(band)}.</li>
				<li>Check grammar, spelling, and punctuation before submitting.</li>
				<li>Aim for ${escapeHTML(words)}.</li>
			</ul>
		`;
		$('promptNice').style.display = 'block';
		const copyBtn = document.getElementById('copyPromptBtn');
		if (copyBtn && navigator && navigator.clipboard) {
			copyBtn.onclick = () => navigator.clipboard.writeText(promptText);
		}

		// Graph visualization: center core nodes and arrange target chips around
		renderPromptGraph({ band, examTask, vocab, structures });
	}

	function renderPromptGraph({ band, examTask, vocab, structures }) {
		const el = $('promptGraph');
		if (!el) return;
		el.innerHTML = '';
		el.style.display = 'block';
		const w = el.clientWidth || 780;
		const h = el.clientHeight || 260;
		// Helper to place a node
		function node(label, x, y, cls=''){
			const d = document.createElement('div');
			d.className = `graph-node ${cls}`.trim();
			d.textContent = label;
			d.style.left = `${Math.max(8, Math.min(w-120, x))}px`;
			d.style.top = `${Math.max(8, Math.min(h-34, y))}px`;
			el.appendChild(d);
			return d;
		}
		function link(x1,y1,x2,y2){
			const dx = x2-x1, dy = y2-y1; const len = Math.sqrt(dx*dx+dy*dy);
			const a = document.createElement('div');
			a.className = 'graph-link';
			a.style.width = `${len}px`;
			a.style.left = `${x1}px`;
			a.style.top = `${y1}px`;
			a.style.transform = `rotate(${Math.atan2(dy,dx)}rad)`;
			el.appendChild(a);
		}
		// Core nodes
		const cx = w/2 - 60, cy = h/2 - 18;
		const nPrompt = node('Prompt', cx-140, cy-30, 'core');
		const nBand = node(`Band ${band}`, cx, cy-60, 'core');
		const nTask = node(`Task ${examTask}`, cx, cy+10, 'core');
		// Satellites (vocab + structures)
		const items = [...(vocab||[]).map(v=>({label:v,type:'vocab'})), ...(structures||[]).map(s=>({label:s,type:'struct'}))];
		const R = Math.min(w,h)/2 - 40;
		items.slice(0,20).forEach((it, i) => {
			const ang = (i / Math.max(1, Math.min(20, items.length))) * Math.PI * 2;
			const x = w/2 + R * Math.cos(ang) - 60;
			const y = h/2 + R * Math.sin(ang) - 18;
			const n = node(it.label, x, y, it.type==='struct' ? 'struct' : '');
			// link to task
			const r1 = n.getBoundingClientRect();
			const r2 = nTask.getBoundingClientRect();
			const bx1 = r1.left - el.getBoundingClientRect().left + r1.width/2;
			const by1 = r1.top - el.getBoundingClientRect().top + r1.height/2;
			const bx2 = r2.left - el.getBoundingClientRect().left + r2.width/2;
			const by2 = r2.top - el.getBoundingClientRect().top + r2.height/2;
			link(bx1, by1, bx2, by2);
		});
		// Links between core nodes
		(function linkCore(){
			const getC = n => {
				const r = n.getBoundingClientRect(); const base = el.getBoundingClientRect();
				return { x: r.left - base.left + r.width/2, y: r.top - base.top + r.height/2 };
			};
			const a = getC(nPrompt), b = getC(nBand), c = getC(nTask);
			link(a.x,a.y,b.x,b.y); link(a.x,a.y,c.x,c.y); link(b.x,b.y,c.x,c.y);
		})();
	}

	function updateAuthHeader(){
		const st = document.getElementById('authState'); const link = document.getElementById('loginLink');
		if (!st) return;
		if (token) { st.textContent = username ? `Logged in as ${username}` : 'Logged in'; if (link) link.style.display='none'; }
		else { st.textContent = 'Logged out'; if (link) link.style.display='inline'; }
	}

	if (token) {
		$('auth-card').style.display = 'none';
		$('prompt-card').style.display = 'block';
		$('write-card').style.display = 'block';
		updateAuthHeader();
		// Fetch server-recommended default band if available
		try {
			fetch('/write/default_band', { headers: { 'Authorization': `Bearer ${token}` } })
				.then(r => r.json()).then(j => { if (j && j.band) { $('band').value = j.band; lastBand = j.band; } });
		} catch (_) {}
	}
	$('loginBtn').addEventListener('click', async () => {
		$('loginBtn').disabled = true; $('loginMsg').textContent = '…';
		try {
			const form = new URLSearchParams();
			form.set('username', $('username').value);
			form.set('password', $('password').value);
			const r = await fetch('/auth/token', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form });
			if (!r.ok) throw new Error('login failed');
			const j = await r.json();
			token = j.access_token; username = $('username').value || null;
			try { localStorage.setItem('token', token); if (username) localStorage.setItem('username', username); } catch(_) {}
			$('loginMsg').textContent = 'Logged in';
			$('prompt-card').style.display = 'block';
			$('write-card').style.display = 'block';
			updateAuthHeader();
		} catch (e) {
			$('loginMsg').textContent = 'Login failed';
		} finally {
			$('loginBtn').disabled = false;
		}
	});

	$('genPromptBtn').addEventListener('click', async () => {
		$('genPromptBtn').disabled = true;
		$('promptNice').style.display = 'block';
		$('promptNice').innerHTML = '<div class="small">Generating prompt…</div>';
		$('promptGraph').style.display = 'none';
		$('promptOut').style.display = 'none';
		$('targetsOut').style.display = 'none';
		try {
			const r = await fetch('/write/prompt', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ band: $('band').value, topic: $('topic').value || null }) });
			const j = await r.json();
			renderPromptBox(j);
			lastBand = j.band || $('band').value;
		} catch (e) {
			$('promptNice').innerHTML = `<div class="small">Failed to generate prompt: ${escapeHTML(String(e))}</div>`;
		} finally {
			$('genPromptBtn').disabled = false;
		}
	});

	$('scoreTextBtn').addEventListener('click', async () => {
		$('scoreTextBtn').disabled = true; $('result-card').style.display = 'block'; $('resultOut').textContent = '…'; $('inlineOut').innerHTML = '';
		try {
			const r = await fetch('/write/score/text', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ text: $('essay').value, band_hint: lastBand }) });
			const t = await r.text();
			let j = null;
			try { j = JSON.parse(t); } catch { j = { raw: t }; }
			if (j.band) $('bandOut').textContent = `Band estimate: ${j.band}`; else $('bandOut').textContent = '';
			$('resultOut').textContent = JSON.stringify(j, null, 2);
			if (j.comments && Array.isArray(j.comments.inline)) {
				$('inlineOut').innerHTML = j.comments.inline.map(a => `<div class="inline-annot"><strong>${a.span||''}</strong><div class="small">${a.comment||''}</div></div>`).join('');
			}
		} catch (e) {
			$('resultOut').textContent = String(e);
		} finally {
			$('scoreTextBtn').disabled = false;
		}
	});

	$('scoreImageBtn').addEventListener('click', async () => {
		const f = $('imageFile').files[0];
		if (!f) { alert('Choose an image first'); return; }
		$('scoreImageBtn').disabled = true; $('result-card').style.display = 'block'; $('resultOut').textContent = '…'; $('inlineOut').innerHTML = '';
		try {
			const form = new FormData();
			form.append('file', f);
			if (lastBand) form.append('band_hint', lastBand);
			const r = await fetch('/write/score/image', { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: form });
			const t = await r.text();
			let j = null;
			try { j = JSON.parse(t); } catch { j = { raw: t }; }
			if (j.band) $('bandOut').textContent = `Band estimate: ${j.band}`; else $('bandOut').textContent = '';
			$('resultOut').textContent = JSON.stringify(j, null, 2);
			if (j.comments && Array.isArray(j.comments.inline)) {
				$('inlineOut').innerHTML = j.comments.inline.map(a => `<div class="inline-annot"><strong>${a.span||''}</strong><div class="small">${a.comment||''}</div></div>`).join('');
			}
		} catch (e) {
			$('resultOut').textContent = String(e);
		} finally {
			$('scoreImageBtn').disabled = false;
		}
	});
	</script>
</body>
</html>


